<div class="flex flex-col h-full bg-white dark:bg-gray-800">
    <!-- Header with Stats and Pagination -->
    <div
        *ngIf="queryResults.length > 0 || rows.length > 0"
        class="flex-shrink-0 px-3 py-2 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800"
    >
        <div class="flex items-center justify-between">
            <!-- Results Info -->
            <div class="flex items-center space-x-3">
                <div
                    class="flex items-center px-2 py-1 bg-white dark:bg-gray-700 rounded border border-gray-200 dark:border-gray-600 shadow-sm"
                >
                    <span class="icon-[mdi--table-large] w-3 h-3 text-blue-600 dark:text-blue-400 mr-1"></span>
                    <span class="text-xs font-medium text-gray-700 dark:text-gray-300"> {{ totalRows }} rows </span>
                </div>
                <div
                    *ngIf="totalPages > 1"
                    class="text-xs text-gray-600 dark:text-gray-400"
                >
                    Page {{ currentPage }} of {{ totalPages }}
                </div>
                <!-- Page size selector moved to the right controls for a cleaner header -->
            </div>

            <!-- Clean page size selector (compact pill) -->
                <div
                    *ngIf="totalRows > 0"
                    class="flex items-center"
                >
                    <label
                        class="sr-only"
                        for="rg-page-size"
                        >Rows per page</label
                    >
                    <div class="inline-flex items-center gap-1 px-2 py-1 rounded dark:bg-gray-700 shadow-sm">
                        <span class="text-[11px] text-gray-600 dark:text-gray-300">Rows</span>
                        <div class="relative">
                            <select
                                id="rg-page-size"
                                class="appearance-none bg-transparent text-[11px] font-medium w-12 px-1 py-0.5 text-xs text-gray-900 dark:text-white focus:outline-none focus:ring-0"
                                [value]="pageSize"
                                (change)="changePageSize($event)"
                                title="Rows per page"
                            >
                                <option
                                    *ngFor="let size of pageSizeOptions"
                                    [value]="size"
                                >
                                    {{ size }}
                                </option>
                            </select>
                        </div>
                    </div>
                </div>

            <!-- Pagination Controls -->
            <div
                *ngIf="totalPages > 1"
                class="flex items-center space-x-1"
            >
                

                <button
                    (click)="changePage(1)"
                    [disabled]="currentPage === 1"
                    class="p-1 rounded border border-gray-300 dark:border-gray-600 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"
                    title="First page"
                >
                    <span class="icon-[mdi--page-first] w-3 h-3"></span>
                </button>
                <button
                    (click)="changePage(currentPage - 1)"
                    [disabled]="currentPage === 1"
                    class="p-1 rounded border border-gray-300 dark:border-gray-600 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"
                    title="Previous page"
                >
                    <span class="icon-[mdi--chevron-left] w-3 h-3"></span>
                </button>

                <!-- Page Input -->
                <div class="flex items-center space-x-1">
                    <input
                        type="number"
                        [value]="currentPage"
                        (keydown.enter)="goToPage($event)"
                        (blur)="goToPage($event)"
                        min="1"
                        [max]="totalPages"
                        class="w-12 px-1 py-0.5 text-xs text-center border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                    />
                    <span class="text-xs text-gray-500 dark:text-gray-400">of {{ totalPages }}</span>
                </div>

                <button
                    (click)="changePage(currentPage + 1)"
                    [disabled]="currentPage === totalPages"
                    class="p-1 rounded border border-gray-300 dark:border-gray-600 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"
                    title="Next page"
                >
                    <span class="icon-[mdi--chevron-right] w-3 h-3"></span>
                </button>
                <button
                    (click)="changePage(totalPages)"
                    [disabled]="currentPage === totalPages"
                    class="p-1 rounded border border-gray-300 dark:border-gray-600 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"
                    title="Last page"
                >
                    <span class="icon-[mdi--page-last] w-3 h-3"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Content Area -->
    <div class="flex-1 overflow-hidden">
        <!-- Loading State -->
        <div
            *ngIf="isLoading"
            class="flex items-center justify-center h-full"
        >
            <div class="flex flex-col items-center space-y-3">
                <div class="relative">
                    <div class="w-8 h-8 border-4 border-blue-200 rounded-full animate-spin"></div>
                    <div
                        class="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin absolute top-0"
                    ></div>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400 font-medium">Executing query...</p>
            </div>
        </div>

        <!-- Error State -->
        <div
            *ngIf="errorMessage && !isLoading"
            class="flex items-center justify-center h-full p-6"
        >
            <div class="text-center max-w-md">
                <div
                    class="w-16 h-16 mx-auto mb-4 bg-red-100 dark:bg-red-900/20 rounded-full flex items-center justify-center"
                >
                    <span class="icon-[mdi--alert-circle] w-8 h-8 text-red-600 dark:text-red-400"></span>
                </div>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Query Error</h3>
                <p
                    class="text-sm text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/10 p-3 rounded-lg border border-red-200 dark:border-red-800"
                >
                    {{ errorMessage }}
                </p>
            </div>
        </div>

        <!-- Empty / Non-SELECT State with details -->
        <div
            *ngIf="!isLoading && !errorMessage && rows.length === 0 && queryResults.length > 0"
            class="h-full"
        >
            <div class="h-full overflow-auto p-4">
                <div class="max-w-3xl mx-auto space-y-4">
                    <!-- Summary card -->
                    <div
                        class="p-4 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm"
                    >
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <span
                                    class="icon-[mdi--information-outline] w-5 h-5 text-gray-500 dark:text-gray-400"
                                ></span>
                                <h3 class="text-base font-semibold text-gray-900 dark:text-gray-100">Query Summary</h3>
                            </div>
                            <span
                                class="text-xs px-2 py-0.5 rounded bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-gray-600"
                            >
                                {{ activeResult?.type || 'UNKNOWN' }}
                            </span>
                        </div>
                        <div class="mt-3">
                            <div class="text-xs text-gray-500 dark:text-gray-400 uppercase mb-1">Statement</div>
                            <pre
                                class="text-sm text-gray-800 dark:text-gray-100 bg-gray-50 dark:bg-gray-900/40 p-3 rounded border border-gray-200 dark:border-gray-700 overflow-auto"
                                >{{ activeResult?.query }}</pre
                            >
                        </div>
                    </div>

                    <!-- Messages -->
                    <div
                        *ngIf="activeResult?.messages?.length"
                        class="p-4 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm"
                    >
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="icon-[mdi--message-badge] w-5 h-5 text-blue-500"></span>
                            <h4 class="text-sm font-semibold text-gray-900 dark:text-gray-100">Messages</h4>
                        </div>
                        <ul class="space-y-2">
                            <li
                                *ngFor="let m of activeResult.messages"
                                class="text-sm text-gray-800 dark:text-gray-200"
                            >
                                <div class="flex items-start justify-between">
                                    <div class="space-x-2">
                                        <span
                                            class="text-xs px-1.5 py-0.5 rounded bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-800"
                                            >{{ m.type || 'INFO' }}</span
                                        >
                                        <span>{{ m.message }}</span>
                                    </div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">
                                        <ng-container *ngIf="m.affectedRows !== undefined"
                                            >affectedRows: {{ m.affectedRows }}&nbsp;â€¢&nbsp;</ng-container
                                        >
                                        <ng-container *ngIf="m.warningCount !== undefined"
                                            >warnings: {{ m.warningCount }}</ng-container
                                        >
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <!-- Pagination/info footer -->
                    <div
                        class="p-3 text-xs text-gray-600 dark:text-gray-400 flex items-center justify-between border border-gray-200 dark:border-gray-700 rounded bg-gray-50 dark:bg-gray-900/30"
                    >
                        <div>
                            Executed at: <span class="font-mono">{{ activeResult?.executedAt || '-' }}</span>
                        </div>
                        <div
                            *ngIf="activeResult?.pagination"
                            class="space-x-2"
                        >
                            <span>page: {{ activeResult.pagination.page }}</span>
                            <span>pageSize: {{ activeResult.pagination.pageSize }}</span>
                            <span>totalPages: {{ activeResult.pagination.totalPages }}</span>
                            <span>hasMore: {{ activeResult.pagination.hasMore }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table with Modern Scrollbar -->
        <div
            *ngIf="!isLoading && !errorMessage && rows.length > 0"
            class="h-full overflow-auto scrollbar-thin scrollbar-thumb-gray-400 scrollbar-track-transparent hover:scrollbar-thumb-gray-600 dark:scrollbar-thumb-gray-600 dark:hover:scrollbar-thumb-gray-500"
        >
            <div class="min-w-full">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <!-- Table Header -->
                    <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0 z-10">
                        <tr>
                            <th
                                *ngFor="let header of headers; trackBy: trackByHeader"
                                scope="col"
                                class="px-2 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider border-r border-gray-200 dark:border-gray-600 last:border-r-0"
                            >
                                <div class="flex items-center space-x-1">
                                    <span class="icon-[mdi--table-column] w-3 h-3"></span>
                                    <span class="truncate">{{ header }}</span>
                                </div>
                            </th>
                        </tr>
                    </thead>

                    <!-- Table Body -->
                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        <tr
                            *ngFor="let row of rows; let rowIndex = index; trackBy: trackByRow"
                            class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150"
                        >
                            <td
                                *ngFor="let header of headers; let colIndex = index; trackBy: trackByHeader"
                                class="px-2 py-1.5 text-sm border-r border-gray-200 dark:border-gray-600 last:border-r-0 relative group"
                                [ngClass]="{
                                    'text-gray-500 dark:text-gray-400 italic': getCellType(row[header]) === 'null',
                                    'text-blue-600 dark:text-blue-400 font-mono': getCellType(row[header]) === 'number',
                                    'text-green-600 dark:text-green-400': getCellType(row[header]) === 'boolean',
                                    'text-purple-600 dark:text-purple-400': getCellType(row[header]) === 'date',
                                    'text-gray-900 dark:text-gray-300': getCellType(row[header]) === 'string',
                                }"
                            >
                                <div
                                    class="flex items-center justify-between cursor-pointer"
                                    (click)="copyToClipboard(row[header], rowIndex, header, $event)"
                                    [title]="'Click to copy: ' + getCellDisplayValue(row[header])"
                                >
                                    <span class="truncate max-w-xs">
                                        {{ getCellDisplayValue(row[header]) | truncate: 50 }}
                                    </span>
                                    <button
                                        class="opacity-0 group-hover:opacity-100 ml-1 p-0.5 rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition-all duration-200"
                                    >
                                        <span class="icon-[mdi--content-copy] w-3 h-3 text-gray-400"></span>
                                    </button>
                                </div>

                                <!-- Copy Tooltip -->
                                <div
                                    *ngIf="copiedCell === rowIndex + '-' + header"
                                    class="absolute z-50 px-2 py-1 text-xs font-medium text-white bg-gray-900 rounded shadow-lg pointer-events-none"
                                    [style.left]="copiedPosition.left + 'px'"
                                    [style.top]="copiedPosition.top + 'px'"
                                >
                                    Copied!
                                    <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-full">
                                        <div class="border-4 border-transparent border-t-gray-900"></div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Initial State -->
        <div
            *ngIf="queryResults.length === 0 && rows.length === 0 && !isLoading && !errorMessage"
            class="flex items-center justify-center h-full"
        >
            <div class="text-center">
                <div
                    class="w-16 h-16 mx-auto mb-4 bg-blue-100 dark:bg-blue-900/20 rounded-full flex items-center justify-center"
                >
                    <span class="icon-[mdi--database-search] w-8 h-8 text-blue-600 dark:text-blue-400"></span>
                </div>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Ready to Execute</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    Write your SQL query and click Execute to see results here.
                </p>
            </div>
        </div>
    </div>
</div>
