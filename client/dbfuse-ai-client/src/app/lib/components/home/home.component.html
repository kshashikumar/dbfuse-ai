<div
    *ngIf="tabs.length > 0; else showInitDBInfo"
    class="flex h-full flex-col bg-white dark:bg-gray-800"
>
    <!-- Tab Bar with Modern Scrollbar and Close All Button -->
    <div class="border-b border-gray-200 dark:border-gray-700">
        <div
            class="flex items-center overflow-x-auto scrollbar-thin scrollbar-thumb-gray-400 scrollbar-track-transparent hover:scrollbar-thumb-gray-600 dark:scrollbar-thumb-gray-600 dark:hover:scrollbar-thumb-gray-500"
        >
            <div
                #tabContainer
                class="flex min-w-max"
            >
                <div
                    *ngFor="let tab of tabs; let i = index; trackBy: trackByTabId"
                    class="tab-draggable flex items-center border-r border-gray-200 dark:border-gray-700 group"
                    [class.bg-white]="selectedTab === i"
                    [class.dark:bg-gray-800]="selectedTab === i"
                    [class.bg-gray-50]="selectedTab !== i"
                    [class.dark:bg-gray-700]="selectedTab !== i"
                    [attr.draggable]="true"
                    aria-label="Tab for {{ tab.displayName }}"
                >
                    <div
                        *ngIf="editingTabIndex !== i; else editTabInput"
                        class="flex items-center"
                        (dblclick)="startEditingTab(i)"
                    >
                        <button
                            (click)="selectTab(i)"
                            class="flex items-center px-3 py-2 text-sm font-medium transition-colors duration-200 focus:outline-none"
                            [class.text-blue-600]="selectedTab === i"
                            [class.dark:text-blue-400]="selectedTab === i"
                            [class.text-gray-600]="selectedTab !== i"
                            [class.dark:text-gray-400]="selectedTab !== i"
                            [class.border-b-2]="selectedTab === i"
                            [class.border-blue-500]="selectedTab === i"
                            [attr.aria-selected]="selectedTab === i"
                            [attr.aria-label]="'Select tab ' + tab.displayName"
                        >
                            <span class="icon-[mdi--table] w-4 h-4 mr-2 flex-shrink-0"></span>
                            <span class="truncate max-w-28">{{ tab.displayName }}</span>
                        </button>
                        <button
                            (click)="closeTab(i)"
                            class="p-1 mr-1 rounded hover:bg-gray-200 dark:hover:bg-gray-600 opacity-0 group-hover:opacity-100 transition-all duration-200"
                            title="Close tab"
                            aria-label="Close tab"
                        >
                            <span
                                class="icon-[mdi--close] w-3 h-3 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
                            ></span>
                        </button>
                    </div>
                    <ng-template #editTabInput>
                        <input
                            type="text"
                            [(ngModel)]="tabs[i].displayName"
                            (blur)="renameTab(i, tabs[i].displayName)"
                            (keydown.enter)="renameTab(i, tabs[i].displayName)"
                            (keydown.escape)="editingTabIndex = null"
                            class="px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 w-28"
                            maxlength="50"
                            aria-label="Edit tab name"
                            #tabInput
                            (focus)="tabInput.select()"
                        />
                    </ng-template>
                </div>
            </div>
            <!-- New Query button in tab management section -->
            <button
                (click)="addNewQueryTab(selectedDB)"
                class="ml-2 px-2 py-1 text-sm font-medium text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 transition-colors duration-200"
                title="Open new query tab"
                aria-label="Open new query tab"
            >
                <span class="icon-[mdi--plus-box] w-4 h-4"></span>
            </button>
            <button
                *ngIf="tabs.length > 0"
                (click)="closeAllTabs()"
                class="ml-2 px-2 py-1 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors duration-200"
                title="Close all tabs"
                aria-label="Close all tabs"
            >
                <span class="icon-[mdi--close-box-multiple] w-4 h-4"></span>
            </button>
        </div>
    </div>

    <!-- Query Editor -->
    <div class="flex flex-col">
        <div *ngIf="selectedTab !== -1">
            <!-- SQL Editor with Dark Mode Support -->
            <div class="border-b border-gray-200 dark:border-gray-700">
                <div
                    #editor
                    class="h-[200px] w-full bg-white dark:bg-gray-900"
                ></div>
            </div>

            <!-- Action Bar with Reduced Spacing -->
            <!-- Action Bar with Reduced Spacing -->
            <div class="px-3 py-2 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
                <div class="flex items-center justify-between">
                    <!-- LEFT: context + per-statement result tabs -->
                    <div class="flex items-center min-w-0 flex-1">
                        <!-- Scrollable result tabs -->
                        <div class="flex-1 min-w-0">
                            <div
                                *ngIf="currentResultTabs.length > 0"
                                class="flex items-center space-x-1 overflow-x-auto overflow-y-hidden whitespace-nowrap scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-gray-600 pb-1 -mb-1 [scrollbar-gutter:stable_both-edges]"
                                style="scrollbar-gutter: stable both-edges"
                            >
                                <ng-container
                                    *ngFor="let r of currentResultTabs; let i = index; trackBy: trackByResultIndex"
                                >
                                    <button
                                        (click)="onSelectResultTab(i)"
                                        class="flex items-center h-8 pl-2 pr-1 text-xs rounded border transition-colors duration-200 max-w-[14rem]"
                                        [class.bg-white]="activeResultIndex === i"
                                        [class.dark:bg-gray-700]="activeResultIndex === i"
                                        [class.bg-gray-100]="activeResultIndex !== i"
                                        [class.dark:bg-gray-800]="activeResultIndex !== i"
                                        [class.border-blue-500]="activeResultIndex === i"
                                        [class.border-gray-300]="activeResultIndex !== i"
                                        [title]="
                                            (r.displayName || getResultTabLabel(r, i)) +
                                            ' | ' +
                                            (r.query | slice: 0 : 80)
                                        "
                                    >
                                        <span class="mr-1 font-semibold truncate leading-none">
                                            {{ r.displayName || getResultTabLabel(r, i) }}
                                        </span>
                                        <span
                                            (click)="onCloseResultTab(i); $event.stopPropagation()"
                                            class="icon-[mdi--close] w-3 h-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 ml-1 flex-shrink-0"
                                            title="Close result tab"
                                            aria-label="Close result tab"
                                        ></span>
                                    </button>
                                </ng-container>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT: buttons (unchanged, fixed width so they never get pushed) -->
                    <div class="flex items-center space-x-2 flex-shrink-0">
                        <button
                            *ngIf="openAIEnabled"
                            (click)="handleOpenAIPrompt()"
                            class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-white bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all duration-200"
                            aria-label="Generate SQL with AI"
                        >
                            <span class="icon-[mdi--auto-fix] w-3 h-3 mr-1"></span>
                            AI Generate
                        </button>

                        <button
                            (click)="handleExecQueryClick()"
                            class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200"
                            aria-label="Execute query"
                        >
                            <span class="icon-[mdi--play] w-3 h-3 mr-1"></span>
                            Execute
                        </button>

                        <button
                            (click)="onDiscQueryClick()"
                            class="inline-flex items-center px-3 py-1.5 border border-gray-300 dark:border-gray-600 text-xs font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200"
                            aria-label="Clear query"
                        >
                            <span class="icon-[mdi--eraser] w-3 h-3 mr-1"></span>
                            Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Grid - Takes remaining space -->
    <div class="flex-1 min-h-0">
        <app-resultgrid
            [triggerQuery]="triggerQuery"
            [dbName]="selectedDB"
            [tabId]="currentTabId"
            [executeTriggered]="executeTriggered"
            (resultsChanged)="onResultsChanged($event)"
        ></app-resultgrid>
    </div>
</div>

<!-- Database Overview with Modern Scrollbar -->
<ng-template #showInitDBInfo>
    <div class="flex h-full flex-col bg-white dark:bg-gray-800">
        <!-- Header -->
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
            <div>
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Database Overview</h2>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Connected databases and their statistics</p>
            </div>
            <!-- New Query button on overview header (right) -->
            <button
                (click)="addNewQueryTab('')"
                class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200"
                aria-label="Open new query tab"
            >
                <span class="icon-[mdi--plus] w-3 h-3 mr-1"></span>
                New Query
            </button>
        </div>

        <!-- Content with Modern Scrollbar -->
        <div
            class="flex-1 overflow-auto p-6 scrollbar-thin scrollbar-thumb-gray-400 scrollbar-track-transparent hover:scrollbar-thumb-gray-600 dark:scrollbar-thumb-gray-600 dark:hover:scrollbar-thumb-gray-500"
        >
            <div *ngIf="paginatedData && paginatedData.length > 0; else emptyState">
                <!-- Database Cards -->
                <div class="grid gap-4 mb-6">
                    <div
                        *ngFor="let db of paginatedData; trackBy: trackByDatabaseName"
                        class="bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 p-4 hover:shadow-md transition-shadow duration-200"
                    >
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center">
                                    <span
                                        class="icon-[mdi--database] w-5 h-5 text-blue-600 dark:text-blue-400 mr-3"
                                    ></span>
                                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">
                                        {{ db.name }}
                                    </h3>
                                </div>
                                <div class="mt-3 grid grid-cols-2 gap-4 text-sm">
                                    <div class="flex items-center">
                                        <span class="icon-[mdi--harddisk] w-4 h-4 text-gray-500 mr-2"></span>
                                        <span class="text-gray-600 dark:text-gray-400">Size:</span>
                                        <span class="ml-1 font-medium text-gray-900 dark:text-white">
                                            {{ convertToReadableSize(db.sizeOnDisk) }}
                                        </span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="icon-[mdi--table] w-4 h-4 text-gray-500 mr-2"></span>
                                        <span class="text-gray-600 dark:text-gray-400">Tables:</span>
                                        <span class="ml-1 font-medium text-gray-900 dark:text-white">
                                            {{ db.tables?.length || 0 }}
                                        </span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="icon-[mdi--eye] w-4 h-4 text-gray-500 mr-2"></span>
                                        <span class="text-gray-600 dark:text-gray-400">Views:</span>
                                        <span class="ml-1 font-medium text-gray-900 dark:text-white">
                                            {{ db.views?.length || 0 }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pagination -->
                <div
                    class="flex items-center justify-between"
                    *ngIf="totalRows > pageSize"
                >
                    <div class="text-sm text-gray-700 dark:text-gray-300">
                        Showing {{ (currentPage - 1) * pageSize + 1 }} to
                        {{ Math.min(currentPage * pageSize, totalRows) }} of {{ totalRows }} databases
                    </div>
                    <div class="flex items-center space-x-2">
                        <button
                            (click)="changePage(currentPage - 1)"
                            [disabled]="currentPage === 1"
                            class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"
                            aria-label="Previous page"
                        >
                            <span class="icon-[mdi--chevron-left] w-4 h-4 mr-1"></span>
                            Previous
                        </button>
                        <span class="text-sm text-gray-700 dark:text-gray-300">
                            Page {{ currentPage }} of {{ getTotalPages() }}
                        </span>
                        <button
                            (click)="changePage(currentPage + 1)"
                            [disabled]="currentPage === getTotalPages()"
                            class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"
                            aria-label="Next page"
                        >
                            Next
                            <span class="icon-[mdi--chevron-right] w-4 h-4 ml-1"></span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <ng-template #emptyState>
                <div class="text-center py-12">
                    <span class="icon-[mdi--database-off-outline] w-16 h-16 text-gray-400 mx-auto block mb-4"></span>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No databases found</h3>
                    <p class="text-gray-600 dark:text-gray-400">
                        Connect to a database to get started with your SQL queries.
                    </p>
                </div>
            </ng-template>
        </div>
    </div>
</ng-template>
